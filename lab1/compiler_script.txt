#!/bin/bash
 
trap "rm -rf ${temp_dir}" EXIT TERM INT QUIT HUP
 
if [ $# -eq 0 ]; then
    echo "Передайте название файла, который необходимо скомпилировать!" >&2
    exit 1000
fi
file=${1}
file_name=${file##*/}
file_path="."
if [[ ${file} =~ / ]]; then
    file_path=${file%/*}
fi
grep -q -m 1 '//Output:' ${file} > /dev/null 2>&1
error_code=$?
if [ ${error_code} -eq 2 ]; then
    echo "Не удалось найти файл ${file}!" >&2
    exit 1001
fi
if [ ${error_code} -eq 1 ]; then
    echo "Не удалось найти комментарий \"//Output:\"!" >&2
    exit 1002
fi
destination=$(grep -m 1 '//Output:' ${file} | sed 's/\/\Output://' | sed 's/ //')
if [ -z ${destination} ]; then
    echo "Название итогового файла не должно быть пустым!" >&2
    exit 1003
fi
temp_dir=$(mktemp -d)
if [ $? -ne 0 ]; then
    echo "Не удалось создать временную директорию!" >&2
    exit 1004
fi
cp ${file} ${temp_dir}
if [ $? -ne 0 ]; then
    echo "Не удалось скопировать файл во временную директорию!" >&2
    exit 1005
fi
g++ ${temp_dir}/${file_name} -o ${file_path}/${destination} > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Не удалось скомпилировать файл!" >&2
    exit 1006
fi